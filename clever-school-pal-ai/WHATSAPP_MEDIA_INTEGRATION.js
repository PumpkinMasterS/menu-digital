/**
 * INTEGRA√á√ÉO WHATSAPP + SUPABASE STORAGE + IA
 * Sistema completo para envio de m√≠dia educacional via WhatsApp
 */

import { createClient } from '@supabase/supabase-js';
import fetch from 'node-fetch';

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

// ================================================================
// 1. CLASSE PRINCIPAL DE INTEGRA√á√ÉO
// ================================================================

class WhatsAppMediaEducacional {
  constructor() {
    this.whatsappToken = process.env.WHATSAPP_ACCESS_TOKEN;
    this.phoneNumberId = process.env.WHATSAPP_PHONE_NUMBER_ID;
    this.baseURL = `https://graph.facebook.com/v19.0/${this.phoneNumberId}/messages`;
  }

  // ================================================================
  // 2. PESQUISA INTELIGENTE DE M√çDIA
  // ================================================================

  async pesquisarMidiaEducacional(pergunta, contextoEstudante) {
    try {
      console.log('üîç Pesquisando m√≠dia educacional para:', pergunta);
      
      // Extrair palavras-chave da pergunta
      const palavrasChave = pergunta.toLowerCase()
        .split(' ')
        .filter(palavra => palavra.length > 3)
        .filter(palavra => !['como', 'onde', 'quando', 'porque', 'para', 'sobre'].includes(palavra));

      console.log('üéØ Palavras-chave extra√≠das:', palavrasChave);

      // Detectar disciplina pela pergunta
      const disciplina = this.detectarDisciplina(pergunta);
      const ano = contextoEstudante?.classes?.grade || 5;

      console.log(`üìö Disciplina detectada: ${disciplina}, Ano: ${ano}`);

      // Buscar m√≠dia relevante
      const { data: midias, error } = await supabase
        .rpc('pesquisar_midia_educacional', {
          consulta: palavrasChave.join(' '),
          disciplina_filtro: disciplina,
          ano_filtro: parseInt(ano),
          tipo_filtro: null
        });

      if (error) {
        console.error('‚ùå Erro ao pesquisar m√≠dia:', error);
        return [];
      }

      console.log(`‚úÖ Encontradas ${midias?.length || 0} m√≠dias relevantes`);
      
      return midias || [];

    } catch (error) {
      console.error('‚ùå Erro na pesquisa de m√≠dia:', error);
      return [];
    }
  }

  // ================================================================
  // 3. DETEC√á√ÉO DE DISCIPLINA
  // ================================================================

  detectarDisciplina(pergunta) {
    const palavrasDisciplinas = {
      matematica: ['matem√°tica', 'fra√ß√µes', 'equa√ß√µes', 'geometria', 'n√∫meros', 'c√°lculo', 'algebra', 'gr√°fico'],
      ciencias: ['ci√™ncias', 'biologia', 'f√≠sica', 'qu√≠mica', 'sistema solar', 'plantas', 'animais', 'corpo humano'],
      geografia: ['geografia', 'portugal', 'europa', 'continentes', 'oceanos', 'clima', 'relevo', 'rios'],
      historia: ['hist√≥ria', 'descobrimentos', 'imp√©rio', 'guerra', 'rei', 'revolu√ß√£o', 'idade m√©dia'],
      portugues: ['portugu√™s', 'gram√°tica', 'literatura', 'texto', 'poema', 'romance', 'verbos']
    };

    const perguntaLower = pergunta.toLowerCase();

    for (const [disciplina, palavras] of Object.entries(palavrasDisciplinas)) {
      if (palavras.some(palavra => perguntaLower.includes(palavra))) {
        return disciplina;
      }
    }

    return null; // Retorna null se n√£o detectar disciplina espec√≠fica
  }

  // ================================================================
  // 4. GERA√á√ÉO DE URLs TEMPOR√ÅRIAS
  // ================================================================

  async gerarUrlTemporaria(midiaId, duracaoMinutos = 60) {
    try {
      // Buscar dados da m√≠dia
      const { data: midia, error } = await supabase
        .from('midia_educacional')
        .select('*')
        .eq('id', midiaId)
        .single();

      if (error || !midia) {
        throw new Error('M√≠dia n√£o encontrada');
      }

      // Gerar URL tempor√°ria do Supabase Storage
      const { data: urlData, error: urlError } = await supabase.storage
        .from(midia.bucket_name)
        .createSignedUrl(midia.caminho_storage, duracaoMinutos * 60);

      if (urlError) {
        console.warn('‚ö†Ô∏è Erro ao gerar URL tempor√°ria, usando URL p√∫blica');
        return midia.url_publica;
      }

      console.log('‚úÖ URL tempor√°ria gerada com sucesso');
      return urlData.signedUrl;

    } catch (error) {
      console.error('‚ùå Erro ao gerar URL tempor√°ria:', error);
      return null;
    }
  }

  // ================================================================
  // 5. ENVIO DE M√çDIA VIA WHATSAPP
  // ================================================================

  async enviarMidiaWhatsApp(phoneNumber, midia, contexto = {}) {
    try {
      console.log(`üì§ Enviando m√≠dia "${midia.titulo}" para ${phoneNumber}`);

      // Gerar URL tempor√°ria
      const urlTemporaria = await this.gerarUrlTemporaria(midia.id, 120); // 2 horas

      if (!urlTemporaria) {
        throw new Error('N√£o foi poss√≠vel gerar URL para a m√≠dia');
      }

      // Preparar payload baseado no tipo de m√≠dia
      let payload = {
        messaging_product: "whatsapp",
        to: phoneNumber,
        type: this.mapearTipoMidia(midia.tipo_midia)
      };

      // Configurar m√≠dia baseada no tipo
      const tipoWhatsApp = this.mapearTipoMidia(midia.tipo_midia);
      
      payload[tipoWhatsApp] = {
        link: urlTemporaria,
        caption: this.gerarLegenda(midia, contexto)
      };

      // Enviar via WhatsApp Cloud API
      const response = await fetch(this.baseURL, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.whatsappToken}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });

      const resultado = await response.json();

      if (!response.ok) {
        throw new Error(`WhatsApp API Error: ${resultado.error?.message || 'Erro desconhecido'}`);
      }

      // Registrar log de sucesso
      await this.registrarLogEnvio(midia.id, contexto.student_id, phoneNumber, {
        whatsapp_message_id: resultado.messages[0]?.id,
        tipo_envio: 'url_temporaria',
        sucesso: true,
        pergunta_original: contexto.pergunta,
        resposta_ia: contexto.resposta
      });

      // Incrementar visualiza√ß√µes
      await supabase.rpc('incrementar_visualizacao', { midia_id: midia.id });

      console.log('‚úÖ M√≠dia enviada com sucesso via WhatsApp');
      return {
        sucesso: true,
        message_id: resultado.messages[0]?.id,
        url_utilizada: urlTemporaria
      };

    } catch (error) {
      console.error('‚ùå Erro ao enviar m√≠dia via WhatsApp:', error);

      // Registrar log de erro
      await this.registrarLogEnvio(midia.id, contexto.student_id, phoneNumber, {
        tipo_envio: 'url_temporaria',
        sucesso: false,
        erro_mensagem: error.message,
        pergunta_original: contexto.pergunta,
        resposta_ia: contexto.resposta
      });

      return {
        sucesso: false,
        erro: error.message
      };
    }
  }

  // ================================================================
  // 6. MAPEAMENTO DE TIPOS DE M√çDIA
  // ================================================================

  mapearTipoMidia(tipoMidia) {
    const mapeamento = {
      'imagem': 'image',
      'video': 'video',
      'audio': 'audio',
      'documento': 'document',
      'pdf': 'document'
    };

    return mapeamento[tipoMidia] || 'document';
  }

  // ================================================================
  // 7. GERA√á√ÉO DE LEGENDAS INTELIGENTES
  // ================================================================

  gerarLegenda(midia, contexto) {
    const emojis = {
      'matematica': 'üî¢',
      'ciencias': 'üî¨',
      'geografia': 'üåç',
      'historia': 'üìú',
      'portugues': 'üìö'
    };

    const emoji = emojis[midia.disciplina] || 'üìñ';
    
    let legenda = `${emoji} *${midia.titulo}*\n\n`;
    
    if (midia.descricao) {
      legenda += `${midia.descricao}\n\n`;
    }

    // Adicionar informa√ß√µes educacionais
    legenda += `üìö *Disciplina:* ${midia.disciplina.charAt(0).toUpperCase() + midia.disciplina.slice(1)}\n`;
    legenda += `üéì *Ano:* ${midia.ano_escolar.join(', ')}¬∫\n`;
    
    if (midia.duracao_segundos) {
      const minutos = Math.ceil(midia.duracao_segundos / 60);
      legenda += `‚è±Ô∏è *Dura√ß√£o:* ${minutos} min\n`;
    }

    if (midia.rating_medio > 0) {
      const estrelas = '‚≠ê'.repeat(Math.round(midia.rating_medio));
      legenda += `${estrelas} (${midia.rating_medio}/5)\n`;
    }

    legenda += `\nüí° *T√≥pico:* ${midia.topico}`;

    return legenda;
  }

  // ================================================================
  // 8. REGISTRO DE LOGS
  // ================================================================

  async registrarLogEnvio(midiaId, studentId, phoneNumber, dadosEnvio) {
    try {
      const { error } = await supabase
        .from('whatsapp_midia_logs')
        .insert({
          midia_id: midiaId,
          student_id: studentId,
          phone_number: phoneNumber,
          ...dadosEnvio,
          created_at: new Date().toISOString()
        });

      if (error) {
        console.warn('‚ö†Ô∏è Erro ao registrar log:', error);
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Erro ao registrar log de envio:', error);
    }
  }

  // ================================================================
  // 9. INTEGRA√á√ÉO COM IA PARA SELE√á√ÉO INTELIGENTE
  // ================================================================

  async selecionarMidiaComIA(pergunta, midias, contextoEstudante) {
    if (!midias || midias.length === 0) return [];

    try {
      // Usar IA para ranquear as m√≠dias por relev√¢ncia
      const prompt = `
        Pergunta do estudante: "${pergunta}"
        Contexto: Estudante do ${contextoEstudante?.classes?.grade || 5}¬∫ ano
        
        M√≠dias dispon√≠veis:
        ${midias.map((m, i) => `${i+1}. ${m.titulo} - ${m.descricao} (${m.tipo_midia})`).join('\n')}
        
        Selecione as 2 m√≠dias mais relevantes para responder √† pergunta.
        Responda apenas com os n√∫meros das m√≠dias, separados por v√≠rgula.
      `;

      // Fazer chamada para IA (OpenRouter)
      const model = process.env.MEDIA_AI_MODEL || 'meta-llama/llama-3.1-70b-instruct';
      const baseUrl = (process.env.OPENROUTER_BASE_URL || 'https://openrouter.ai/api/v1').replace(/\/+$/, '');
      const url = `${baseUrl}/chat/completions`;

      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
        'HTTP-Referer': 'https://clever-school-pal-ai',
        'X-Title': 'EduBot Media Selector'
      };

      const response = await fetch(url, {
        method: 'POST',
        headers,
        body: JSON.stringify({
          model,
          messages: [
            { role: 'system', content: 'Voc√™ √© um assistente educacional especializado em selecionar conte√∫do relevante.' },
            { role: 'user', content: prompt }
          ],
          temperature: 0.3,
          max_tokens: 100
        })
      });

      if (response.ok) {
        const data = await response.json();
        const resposta = data.choices[0]?.message?.content || '';
        
        // Extrair n√∫meros da resposta da IA
        const indices = resposta.match(/\d+/g)?.map(n => parseInt(n) - 1) || [0];
        
        // Retornar m√≠dias selecionadas
        return indices
          .filter(i => i >= 0 && i < midias.length)
          .slice(0, 2) // M√°ximo 2 m√≠dias
          .map(i => midias[i]);
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è IA OpenRouter n√£o dispon√≠vel, usando sele√ß√£o por relev√¢ncia:', error);
    }

    // Fallback: retornar as 2 primeiras (j√° ordenadas por relev√¢ncia)
    return midias.slice(0, 2);
  }

  // ================================================================
  // 10. FUN√á√ÉO PRINCIPAL DE PROCESSAMENTO
  // ================================================================

  async processarPerguntaComMidia(pergunta, contextoEstudante, phoneNumber) {
    try {
      console.log('üöÄ Processando pergunta com m√≠dia educacional...');

      // 1. Pesquisar m√≠dias relevantes
      const midias = await this.pesquisarMidiaEducacional(pergunta, contextoEstudante);

      if (!midias || midias.length === 0) {
        console.log('‚ÑπÔ∏è Nenhuma m√≠dia encontrada para a pergunta');
        return {
          midiaEncontrada: false,
          resposta: 'N√£o encontrei conte√∫do multim√≠dia espec√≠fico para sua pergunta, mas posso explicar o conceito de forma textual.'
        };
      }

      // 2. Selecionar melhores m√≠dias com IA
      const midiasSelecionadas = await this.selecionarMidiaComIA(pergunta, midias, contextoEstudante);

      console.log(`üìé Selecionadas ${midiasSelecionadas.length} m√≠dias para envio`);

      // 3. Enviar m√≠dias selecionadas
      const resultadosEnvio = [];
      
      for (const midia of midiasSelecionadas) {
        const resultado = await this.enviarMidiaWhatsApp(phoneNumber, midia, {
          student_id: contextoEstudante?.id,
          pergunta: pergunta,
          resposta: `Enviei ${midia.tipo_midia}: ${midia.titulo}`
        });

        resultadosEnvio.push({
          midia: midia.titulo,
          tipo: midia.tipo_midia,
          sucesso: resultado.sucesso,
          erro: resultado.erro
        });
      }

      // 4. Gerar resposta textual complementar
      let respostaTexto = this.gerarRespostaComplementar(pergunta, midiasSelecionadas);

      return {
        midiaEncontrada: true,
        midiasSelecionadas: midiasSelecionadas.length,
        resultadosEnvio,
        resposta: respostaTexto
      };

    } catch (error) {
      console.error('‚ùå Erro no processamento:', error);
      return {
        midiaEncontrada: false,
        erro: error.message,
        resposta: 'Ocorreu um erro ao buscar conte√∫do multim√≠dia. Posso explicar o conceito de forma textual.'
      };
    }
  }

  // ================================================================
  // 11. RESPOSTA COMPLEMENTAR
  // ================================================================

  gerarRespostaComplementar(pergunta, midias) {
    if (!midias || midias.length === 0) {
      return 'N√£o encontrei conte√∫do multim√≠dia espec√≠fico para sua pergunta.';
    }

    let resposta = `üìé Enviei ${midias.length} conte√∫do(s) educacional(is) para te ajudar:\n\n`;

    midias.forEach((midia, index) => {
      const emoji = {
        'video': 'üé•',
        'audio': 'üîä',
        'imagem': 'üñºÔ∏è',
        'documento': 'üìÑ',
        'pdf': 'üìã'
      }[midia.tipo_midia] || 'üìé';

      resposta += `${emoji} **${midia.titulo}**\n`;
      if (midia.descricao) {
        resposta += `   ${midia.descricao}\n`;
      }
      resposta += '\n';
    });

    resposta += `üí° Estes recursos foram selecionados especificamente para sua pergunta: "${pergunta}"\n\n`;
    resposta += `üìö Se tiveres d√∫vidas ap√≥s consultar o material, posso explicar mais detalhadamente!`;

    return resposta;
  }
}

// ================================================================
// 12. EXPORTAR E EXEMPLO DE USO
// ================================================================

export default WhatsAppMediaEducacional;

// Exemplo de uso:
/*
const mediaSystem = new WhatsAppMediaEducacional();

// Em uma fun√ß√£o de webhook do WhatsApp:
const resultado = await mediaSystem.processarPerguntaComMidia(
  "Como funcionam as fra√ß√µes?",
  { 
    id: "student-123", 
    classes: { grade: 5 },
    phone_number: "+351912345678"
  },
  "+351912345678"
);

console.log('Resultado:', resultado);
*/